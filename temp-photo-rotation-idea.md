# Photo Frame Ideas: Rotation + Command Queue

## Overview
Two related ideas for a mostly-sleeping ESP32 photo frame:
1. A **two-tier photo rotation** (permanent + temporary photos).
2. A **command queue** processed on wake to control the device.

---

## Photo Rotation Model

### Photo Classes
- **Permanent photos**: evergreen memories; always in rotation.
- **Temporary photos**: short-lived moments; removed after a limited time (e.g., 24 hours).

### Rules
- **50/50 alternation**: permanent, temporary, permanent, temporary, ...
- **No cool-down** behavior after expiration.
- **Expiration**: temporary photos are removed from rotation when TTL ends.

### Rationale
- Keeps classics without losing freshness.
- Predictable pacing for users.
- Simple mental model.

---

## Command Queue (Sleeping Device)
Commands are queued externally (similar to how images are staged) and processed on wake.

### Example Commands
- Delete photo ABC
- Change refresh interval to 120 seconds
- Delete all photos from SD card

### Decisions / Constraints
- **Acknowledgments**: deleting the command from the queue counts as the ack.
- **TTL**: out of scope for now.
- **Priority levels**: out of scope for now.
- **Batching**: process multiple commands per wake to reduce wake cycles.
- **Safety confirmation**: not possible (no on-device interaction), so destructive commands run as-is.

## Photo Rotation Implementation Plan
### SD Storage Layout
- `/queue-permanent/` holds permanent delivery items.
- `/queue-temporary/` holds temporary delivery items (filename encodes expiry).
- `all/permanent/` and `all/temporary/` are the truth store.

### Filename Encoding (Temp Queue)
Use a **lexicographically sortable timestamp** so listing order matches enqueue order and also encodes expiration.

**Proposed format:**
```
queue-temporary/<EXPIRES_UTC>__<UPLOAD_UTC>__<slug>.g4
```

**Examples:**
```
queue-temporary/20250122T120000Z__20250121T120000Z__f4b6b6d8-6b7a-4b69-9f5b-1c3f8c3b2a11.g4
queue-temporary/20250122T183000Z__20250121T183000Z__a2d1a97c-7f3d-4a2f-8b5f-7a8d2c9e4d10.g4
```

**Why two timestamps?**
- `EXPIRES_UTC` lets the device decide when to delete from SD.
- `UPLOAD_UTC` preserves a stable FIFO order if two items share the same expiry.

### Filename Encoding (Perm Queue)
Permanent photos do not expire, so only ordering is needed.

**Proposed format:**
```
queue-permanent/<UPLOAD_UTC>__<guid>.g4
```

**Example:**
```
queue-permanent/20250121T120000Z__f4b6b6d8-6b7a-4b69-9f5b-1c3f8c3b2a11.g4
```

### Device Behavior
- **Download order:** list blobs under `queue-temporary/`, pick the earliest `EXPIRES_UTC` then `UPLOAD_UTC` (natural lexicographic order).
- **Permanent order (if needed):** list blobs under `queue-permanent/`, pick by `UPLOAD_UTC` (natural lexicographic order).
- **Expiration cleanup:** while scanning for the next temp photo, delete expired temp files and keep scanning until a valid temp is found or none remain.
- **Alternation:** follow the 50/50 permanent/temporary rotation when at least one valid temp exists.
- **Temp empty behavior:** if temp queue is empty, skip temp and retry on next wake.
- **Clock source:** on wake, connect to WiFi and set time via NTP before expiration checks. If NTP fails, skip expiration checks for this wake.
- **Persistence:** store last-shown state for both perm and temp to avoid repeating the same image too often.

### Notes
- All timestamps are UTC in `YYYYMMDDTHHMMSSZ` format to avoid timezone ambiguity.
- Slug is generated by the upload site and is a GUID.
- Current SD code supports queue prefixes and caps filenames at 127 chars. Legacy `/perm/` and `/temp/` are obsolete.
- Verify filename length against SD/Arduino constraints for your target filesystem.
- Keep names short to stay within filename limits.